services:
  # TADA API 后端（生产）
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: tada-server:local
    container_name: tada-server
    restart: always
    working_dir: /app
    volumes:
      - tada-server-data:/app/packages/server/data
      - tada-server-uploads:/app/packages/server/uploads
    expose:
      - "8787"
    environment:
      - NODE_ENV=production
      - TADA_SERVER_PORT=8787
      - TADA_DB_PATH=/app/packages/server/data/tada-server.db
      - TADA_UPLOAD_DIR=/app/packages/server/uploads
      - TADA_ALLOW_REGISTRATION=true
      - TADA_JWT_SECRET=change-this-secret
      - TADA_PUBLIC_URL=https://tada.raythunder.tech/api

  # 构建前端产物（一次性）
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        VITE_TADA_API_URL: https://tada.raythunder.tech/api
    image: tada-web:local
    container_name: tada-web-build
    restart: "no"
    working_dir: /app
    volumes:
      - tada-web-dist:/dist
    command: sh -c "rm -rf /dist/* && cp -r /dist-src/* /dist/"

  # Caddy 反向代理 + 静态托管
  caddy:
    image: caddy:2
    container_name: tada-caddy
    restart: always
    depends_on:
      - server
    ports:
      - "5000:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - tada-web-dist:/srv
      - caddy_data:/data
      - caddy_config:/config

volumes:
  tada-server-data:
  tada-server-uploads:
  tada-web-dist:
  caddy_data:
  caddy_config:
